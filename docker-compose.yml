version: '3.9'
services:
  mysql:
    image: mysql:8.0
    container_name: dat-mysql
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=tracker
      - MYSQL_DATABASE=tracker
      - MYSQL_USER=tracker
      - MYSQL_PASSWORD=tracker
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql

  signal-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-api
    restart: unless-stopped
    ports:
      - "8082:8080"
    volumes:
      - signal-data:/home/.local/share/signal-cli
    environment:
      - MODE=json-rpc

  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: dat-server
    restart: unless-stopped
    depends_on:
      - mysql
      - signal-api
    environment:
      - SIGNAL_API_URL=http://signal-api:8080
      - SIGNAL_API_PUBLIC_URL=http://localhost:8082
      - AUTH_DIR=/app/auth_info_baileys
      - COOKIE_SECURE=false
      - JWT_SECRET=please-change-me-to-a-long-secret-32chars-min
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=tracker
      - MYSQL_PASSWORD=tracker
      - MYSQL_DATABASE=tracker
    volumes:
      - wa-auth:/app/auth_info_baileys
    ports:
      - "3005:3001"

  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: dat-client
    restart: unless-stopped
    depends_on:
      - server
    environment:
      - PORT=3002
      - NEXT_PUBLIC_API_BASE=http://localhost:3005
      - NEXT_PUBLIC_SOCKET_URL=http://localhost:3005
    ports:
      - "3002:3002"

volumes:
  signal-data:
  wa-auth:
  mysql-data:
